<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat de Prueba</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* --- Estilos Globales y de Layout --- */
html, body {
    height: 100%;
    margin: 0;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

#app-container {
    display: flex;
    height: 100%;
    width: 100%;
}

/* --- Estilos de Login (sin cambios mayores) --- */
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
}

#login-view {
    margin: auto;
    animation: fadeIn 0.5s ease-in-out;
    width: 100%;
    max-width: 380px;
    padding: 0 20px;
    box-sizing: border-box;
    /* JS controla el display */
}

.app-title {
    color: white;
    text-align: center;
    font-size: 2.2em;
    font-weight: 300;
    margin-bottom: 4.5rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.25);
}

#login-form-card {
    width: 100%; margin: auto; padding: 40px; background-color: white;
    border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    text-align: center;
    box-sizing: border-box;
        margin-bottom: 8.5rem;

}
#login-form-card h2 { margin-top: 0; margin-bottom: 30px; color: #333; font-size: 2em; font-weight: 600; }
#login-form-card input {
    width: 100%; padding: 15px; margin-bottom: 20px; box-sizing: border-box;
    border-radius: 8px; border: 1px solid #ccc; font-size: 1em; transition: all 0.3s ease;
}
#login-form-card input:focus {
    outline: none; border-color: #764ba2; box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.2);
}
#login-form-card button {
    width: 100%; padding: 15px; margin-top: 10px; box-sizing: border-box;
    border-radius: 8px; background-color: #764ba2; color: white; border: none;
    cursor: pointer; font-size: 1.1em; font-weight: bold; transition: background-color 0.3s ease, transform 0.1s ease;
}
#login-form-card button:hover { background-color: #623c85; }
#login-form-card button:active { transform: scale(0.98); }

/* --- ESTILOS DEL CHAT (MEJORADOS) --- */
#chat-container {
    display: none; /* Activado por JS */
    flex-grow: 1;
    display: flex;
    height: 100%;
    background-color: #f0f2f5;
}

/* --- Panel Izquierdo (Contactos) --- */
#left-panel {
    width: 30%;
    max-width: 350px;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    background-color: white;
}
#left-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative; /* Para que la sombra se vea sobre la lista */
    z-index: 2;
}
.chat-view-title {
    margin: 0;
    font-size: 1.05em;
    font-weight: 600;
}
.user-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}
#current-user-name {
    font-size: 0.9em;
    opacity: 0.9;
}

/* --- Estilos para el menú desplegable de 3 puntos --- */
.dropdown {
    position: relative;
    display: inline-block;
}
.kebab-menu {
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s ease;
}
.kebab-menu:hover {
    background-color: rgba(255, 255, 255, 0.15);
}
/* Estilo específico para el menú en el header del chat (fondo claro) */
#chat-header .kebab-menu:hover {
    background-color: #e4e6eb;
}
#chat-header .kebab-menu svg {
    fill: #65676b; /* Un color oscuro para que contraste */
}
.kebab-menu svg {
    width: 24px;
    height: 24px;
    fill: white;
}
.dropdown-content {
    display: none; /* Oculto por defecto */
    position: absolute;
    right: 0;
    top: 40px;
    background-color: white;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 8px;
    padding: 8px 0;
}
.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    font-size: 0.95em;
}
.dropdown-content a:hover { background-color: #f1f1f1; }
.show { display: block; } /* Clase para mostrar el menú */

#contacts-list { overflow-y: auto; flex-grow: 1; }

/* --- NUEVOS ESTILOS PARA AVATARES Y LISTA DE CONTACTOS --- */
.contact-item {
    display: flex;
    align-items: center;
    padding: 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    font-size: 1.1em;
    color: #333;
    text-decoration: none;
    transition: background-color 0.2s ease;
}
.contact-item:hover { background-color: #f5f5f5; }
.contact-item.active {
    background-color: #e8eaf6; /* Un color de fondo suave */
    box-shadow: inset 4px 0 0 #667eea; /* Barra lateral indicadora */
}

/* --- Estilos para la barra de scroll (WebKit) --- */
#contacts-list::-webkit-scrollbar {
    width: 6px;
}
#contacts-list::-webkit-scrollbar-track {
    background: #f1f1f1;
}
#contacts-list::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}
#contacts-list::-webkit-scrollbar-thumb:hover {
    background: #aaa;
}

.contact-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e0e0e0;
    color: white;
    font-size: 1.2em;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-right: 15px;
    text-transform: uppercase;
}

/* --- Panel Derecho (Chat) --- */
#right-panel {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
}

#placeholder-right-panel {
    flex-grow: 1; display: flex; flex-direction: column; align-items: center;
    justify-content: center; color: #65676b; text-align: center; position: relative;
}

.placeholder-brand {
    position: absolute;
    bottom: 20px;
    font-size: 0.9em;
    color: #b0b3b8;
}

#chat-window {
    display: none;
    height: 100%;
    display: flex;
    flex-direction: column;
}

#chat-header {
    padding: 10px 15px; border-bottom: 1px solid #ddd; background-color: #f5f5f5;
    font-weight: bold; font-size: 1.1em; display: flex; align-items: center; justify-content: space-between;
}

.chat-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

#back-to-contacts {
    display: none;
    border: none; background: transparent; font-size: 24px;
    margin-right: 15px; cursor: pointer; padding: 0 10px;
}

#messages-container {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.message {
    max-width: 70%; padding: 10px 15px; border-radius: 18px;
    margin-bottom: 10px; line-height: 1.4; word-wrap: break-word;
}
.message.sent { background-color: #0084ff; color: white; align-self: flex-end; }
.message.received { background-color: #e4e6eb; color: #050505; align-self: flex-start; }

#message-input-container {
    display: flex; padding: 10px; border-top: 1px solid #ddd; background-color: white;
}
#message-input {
    flex-grow: 1; border: 1px solid #ccc; border-radius: 18px;
    padding: 10px 15px; font-size: 1em;
}
#message-input:focus { outline: none; }
#message-input-container button {
    margin-left: 10px; border: none; background-color: #0084ff; color: white;
    border-radius: 50%; width: 40px; height: 40px; cursor: pointer;
    font-size: 18px; flex-shrink: 0;
}

/* --- RESPONSIVIDAD PARA MÓVILES --- */
@media (max-width: 768px) {
    #login-form-card {
        padding: 30px 20px; /* Reducir padding en móvil */
    }

    #left-panel {
        width: 100%;
        max-width: 100%;
        border-right: none;
    }

    #right-panel {
        display: none;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: white;
    }

    #back-to-contacts {
        display: block;
    }

    #chat-container.chat-active-mobile #left-panel {
        display: none;
    }

    #chat-container.chat-active-mobile #right-panel {
        display: flex;
    }
}

/* --- ESTILOS DEL FOOTER --- */
#app-footer {
    position: absolute;
    bottom: 15px;
    left: 0;
    width: 100%;
    text-align: center;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.85em;
    line-height: 1.5;
}
#app-footer a {
    color: #fff;
    text-decoration: none;
    font-weight: 600;
}
#app-footer a:hover {
    text-decoration: underline;
}
</style>

<!--para not push fmc inicio-->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<!--para not push fmc fin-->

</head>
<body>

<div id="app-container">
  <div id="login-view">
    <h1 class="app-title">InnovAztlan Chat Service</h1>
    <div id="login-form-card">
      <h2>Iniciar Sesión</h2>
      <input type="text" id="username-input" placeholder="Nombre de usuario">
      <input type="password" id="password-input" placeholder="Contraseña" onkeydown="if(event.key === 'Enter') login()">
      <button id="login-button">Entrar</button>
    </div>
  </div>
  
  <div id="chat-container">
    <div id="left-panel">
      <div id="left-panel-header">
        <h3 class="chat-view-title">InnovAztlan Chat Service</h3>
        <div class="user-actions">
          <span id="current-user-name"></span>
          <div class="dropdown">
            <div class="kebab-menu" onclick="toggleDropdown('logout-dropdown')">
              <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
            </div>
            <div id="logout-dropdown" class="dropdown-content">
              <a href="#" class="logout-link">Cerrar Sesión</a>
            </div>
          </div>
        </div>
      </div>
      <div id="contacts-list"></div>
    </div>
    <div id="right-panel">
      <div id="placeholder-right-panel">
        <h2>Tu mensajero personal</h2>
        <p>Selecciona un contacto para empezar a chatear.</p>
        <div class="placeholder-brand">InnovAztlan Chat Service</div>
      </div>
      <div id="chat-window">
        <div id="chat-header">
            <div class="chat-header-left">
                <button id="back-to-contacts">←</button>
                <span id="chat-partner-name"></span>
            </div>
            <div class="dropdown">
                <div class="kebab-menu" onclick="toggleDropdown('chat-header-dropdown')">
                  <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                </div>
                <div id="chat-header-dropdown" class="dropdown-content">
                  <a href="#" class="logout-link">Cerrar Sesión</a>
                </div>
            </div>
        </div>
        <div id="messages-container"></div>
        <div id="message-input-container">
          <input type="text" id="message-input" placeholder="Escribe un mensaje..." onkeydown="if(event.key === 'Enter') sendMessage()">
          <button onclick="sendMessage()">➤</button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer id="app-footer">
  Copyright © 2025 innovaztlan.com<br>
  Powered by <a href="https://innovaztlan.com" target="_blank" rel="noopener noreferrer">innovaztlan.com</a>
</footer>
<!-- 
<script>

const API_BASE = "{api_base}";
const PROJECT_ID = "{project_id}";
const API_KEY = "{api_key}";
const USERS = {users_json};

let loggedInUser = null;
let projectChats = [];
let activeChat = null;
let messagePollingInterval = null;

const loginView = document.getElementById('login-view');
const chatContainer = document.getElementById('chat-container');
const leftPanel = document.getElementById('left-panel');
const rightPanel = document.getElementById('right-panel');
const usernameInput = document.getElementById('username-input');
const passwordInput = document.getElementById('password-input');
const contactsList = document.getElementById('contacts-list');
const chatWindow = document.getElementById('chat-window');
const placeholderRightPanel = document.getElementById('placeholder-right-panel');
const chatPartnerName = document.getElementById('chat-partner-name');
const messagesContainer = document.getElementById('messages-container');
const messageInput = document.getElementById('message-input');
const currentUserNameEl = document.getElementById('current-user-name');
const backButton = document.getElementById('back-to-contacts');
const loginButton = document.getElementById('login-button');
const dropdownMenus = document.getElementsByClassName('dropdown-content');

async function initializeApp() {
    // Adjuntar listeners de eventos estáticos
    loginButton.addEventListener('click', login);
    
    const logoutLinks = document.getElementsByClassName('logout-link');
    for (let i = 0; i < logoutLinks.length; i++) {
        logoutLinks[i].addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    }

    // Cerrar el dropdown si se hace clic fuera de él
    window.onclick = function(event) {
      if (!event.target.closest('.kebab-menu')) {
        for (let i = 0; i < dropdownMenus.length; i++) {
          let openDropdown = dropdownMenus[i];
          if (openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
          }
        }
      }
    }

    backButton.addEventListener('click', handleBackToContacts);

    const token = localStorage.getItem('chat_token');
    if (token) {
        await validateSessionAndShowChat(token);
    } else {
        showLoginView();
    }
}

async function validateSessionAndShowChat(token) {
    try {
        const response = await fetch('/me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Token inválido o sesión expirada');
        loggedInUser = await response.json();
        await showChatView();
    } catch (error) {
        console.error("Error de sesión:", error);
        localStorage.removeItem('chat_token');
        showLoginView();
    }
}

function showLoginView() {
    chatContainer.style.display = 'none';
    loginView.style.display = 'block';
    document.getElementById('app-footer').style.display = 'block';
    usernameInput.focus();
}

async function showChatView() {
    loginView.style.display = 'none';
    chatContainer.style.display = 'flex';
    document.getElementById('app-footer').style.display = 'none';
    currentUserNameEl.textContent = `Hola, ${loggedInUser.name}`;
    await loadProjectChats();
    populateContacts();
}

// Función para iniciar sesión
async function login() {
  const name = usernameInput.value.trim();
  const password = passwordInput.value;
  if (!name || !password) {
    alert("Por favor, introduce nombre de usuario y contraseña.");
    return;
  }
  try {
    const response = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, password })
    });
    if (!response.ok) throw new Error('Credenciales incorrectas');    
    const data = await response.json();
    localStorage.setItem('chat_token', data.token);
    loggedInUser = data.user;
    await showChatView();
  } catch (error) {
    console.error("Error de login:", error);
    alert("Login fallido. Revisa tu usuario y contraseña.");
  }
}

// Función para cerrar sesión
function logout() {
    localStorage.removeItem('chat_token');
    window.location.reload(); // La forma más simple de resetear el estado de la app
}

// Función para mostrar/ocultar el menú desplegable
function toggleDropdown(dropdownId) {
    // Cierra todos los demás menús abiertos
    for (let i = 0; i < dropdownMenus.length; i++) {
        let openDropdown = dropdownMenus[i];
        if (openDropdown.id !== dropdownId && openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
        }
    }
    // Muestra/oculta el menú específico
    document.getElementById(dropdownId).classList.toggle("show");
}

function stringToColor(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  let color = '#';
  for (let i = 0; i < 3; i++) {
    const value = (hash >> (i * 8)) & 0xFF;
    color += ('00' + value.toString(16)).substr(-2);
  }
  return color;
}

function handleBackToContacts() {
    chatContainer.classList.remove('chat-active-mobile');
    if (messagePollingInterval) clearInterval(messagePollingInterval);
    activeChat = null;
    document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
}

function populateContacts() {
  contactsList.innerHTML = '';
  const otherUsers = USERS.filter(u => u.uuid !== loggedInUser.uuid);
  otherUsers.forEach(user => {
    const contactDiv = document.createElement('div');
    contactDiv.className = 'contact-item';

    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'contact-avatar';
    avatarDiv.style.backgroundColor = stringToColor(user.name);
    avatarDiv.textContent = user.name.charAt(0);

    const nameSpan = document.createElement('span');
    nameSpan.textContent = user.name;
    
    contactDiv.appendChild(avatarDiv);
    contactDiv.appendChild(nameSpan);

    contactDiv.dataset.userId = user.uuid;
    contactDiv.onclick = () => openChatWithUser(user);
    contactsList.appendChild(contactDiv);
  });
}

async function loadProjectChats() {
  try {
    const response = await fetch(`${API_BASE}/chats`, {
      headers: { 'X-Project-Id': PROJECT_ID, 'X-Api-Key': API_KEY }
    });
    if (!response.ok) throw new Error('Fallo al cargar los chats');
    projectChats = await response.json();
  } catch (error) {
    console.error("Error cargando los chats del proyecto:", error);
  }
}

async function openChatWithUser(contactUser) {
  if (messagePollingInterval) clearInterval(messagePollingInterval);

  document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
  document.querySelector(`.contact-item[data-user-id='${contactUser.uuid}']`)?.classList.add('active');
  chatContainer.classList.add('chat-active-mobile');

  let chat = projectChats.find(c =>
    c.type === 'direct' && c.users.length === 2 &&
    c.users.includes(loggedInUser.uuid) && c.users.includes(contactUser.uuid)
  );

  if (!chat) {
    try {
      const response = await fetch(`${API_BASE}/chats/direct`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Project-Id': PROJECT_ID, 'X-Api-Key': API_KEY
        },
        body: JSON.stringify({ users: [loggedInUser.uuid, contactUser.uuid] })
      });
      if (!response.ok) throw new Error('Fallo al crear el chat remoto');
      chat = await response.json();
      projectChats.push(chat);
    } catch (error) {
      console.error("Error creando el chat remoto:", error);
      alert("No se pudo crear un nuevo chat remoto.");
      return;
    }
  }

  activeChat = chat;
  placeholderRightPanel.style.display = 'none';
  chatWindow.style.display = 'flex';
  chatPartnerName.textContent = `Chat con ${contactUser.name}`;
  messageInput.focus();

  await loadMessages();
  messagePollingInterval = setInterval(loadMessages, 3000);
}

async function loadMessages() {
  if (!activeChat) return;
  try {
    const response = await fetch(`${API_BASE}/chats/${activeChat.id}/messages`, {
      headers: { 'X-Project-Id': PROJECT_ID, 'X-Api-Key': API_KEY }
    });
    if (!response.ok) throw new Error('Fallo al cargar los mensajes');
    const messages = await response.json();
    renderMessages(messages);
  } catch (error) {
    console.error(`Error cargando mensajes para el chat ${activeChat.id}:`, error);
  }
}

function renderMessages(messages) {
  const shouldScroll = messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 30;
  
  messagesContainer.innerHTML = '';
  messages.forEach(msg => {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + (msg.sender_id === loggedInUser.uuid ? 'sent' : 'received');

    const messageText = document.createElement('div');
    messageText.textContent = msg.text;

    const messageTimestamp = document.createElement('span');
    messageTimestamp.textContent = new Date(msg.timestamp).toLocaleString();
    messageTimestamp.style.cssText = `font-size: 0.7em; display: block; color: ${msg.sender_id === loggedInUser.uuid ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.5)'};`;

    messageDiv.appendChild(messageText);
    messageDiv.appendChild(messageTimestamp);
    messagesContainer.appendChild(messageDiv);
  });

  if (shouldScroll) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
}

async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text || !activeChat) return;

  try {
    await fetch(`${API_BASE}/chats/${activeChat.id}/messages`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Project-Id': PROJECT_ID, 'X-Api-Key': API_KEY
      },
      body: JSON.stringify({ sender_id: loggedInUser.uuid, text })
    });
    messageInput.value = '';
    messageInput.focus();
    await loadMessages();
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  } catch (error) {
    console.error("Error enviando el mensaje:", error);
    alert("No se pudo enviar el mensaje.");
  }
}

window.onload = initializeApp;

</script> -->



<script>
const API_BASE = "{api_base}";
const PROJECT_ID = "{project_id}";
const API_KEY = "{api_key}";
const USERS = {users_json};

let loggedInUser = null;
let projectChats = [];
let activeChat = null;
let messagePollingInterval = null;
let messaging = null; // Variable for the messaging object

const loginView = document.getElementById('login-view');
const chatContainer = document.getElementById('chat-container');
const leftPanel = document.getElementById('left-panel');
const rightPanel = document.getElementById('right-panel');
const usernameInput = document.getElementById('username-input');
const passwordInput = document.getElementById('password-input');
const contactsList = document.getElementById('contacts-list');
const chatWindow = document.getElementById('chat-window');
const placeholderRightPanel = document.getElementById('placeholder-right-panel');
const chatPartnerName = document.getElementById('chat-partner-name');
const messagesContainer = document.getElementById('messages-container');
const messageInput = document.getElementById('message-input');
const currentUserNameEl = document.getElementById('current-user-name');
const backButton = document.getElementById('back-to-contacts');
const loginButton = document.getElementById('login-button');
const dropdownMenus = document.getElementsByClassName('dropdown-content');

// // START: Firebase Config
// const firebaseConfig = {
//     apiKey: API_KEY,
//     projectId: PROJECT_ID,
//     appId: "1:896256118832:web:a539d665011e0ac9315df5", // Añade esta línea

// };
// // END: Firebase Config


// START: Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyCMuEJ_TY6OsdId9vWTLJLgyQ5LWr7P3KU",
    projectId: "chat-48f40",
    appId: "1:896256118832:web:a539d665011e0ac9315df5",
    messagingSenderId: "896256118832" // ¡Esta es la línea que falta!
};
// END: Firebase Config





async function initializeApp() {


  // Adjuntar listeners de eventos estáticos
    loginButton.addEventListener('click', login);
    
    const logoutLinks = document.getElementsByClassName('logout-link');
    for (let i = 0; i < logoutLinks.length; i++) {
        logoutLinks[i].addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });
    }

    // START: Registro del Service Worker para notificaciones push
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
            .then((registration) => {
                console.log('Service Worker registrado con éxito:', registration);
                // Si el registro es exitoso, ahora inicializa Firebase
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                    messaging = firebase.messaging();
                }
                
                // Agrega el onMessage listener aquí para asegurarte de que
                // el Service Worker ya está en proceso de registro.
                messaging.onMessage((payload) => {
                    console.log('Mensaje recibido en primer plano:', payload);
                    const notificationTitle = payload.notification.title;
                    const notificationOptions = {
                        body: payload.notification.body,
                    };
                    new Notification(notificationTitle, notificationOptions);
                    if (activeChat && payload.data && payload.data.chat_id === activeChat.id) {
                        loadMessages();
                    }
                });
            })
            .catch((error) => {
                console.error('Fallo al registrar el Service Worker:', error);
            });
    } else {
        console.warn('Este navegador no soporta Service Workers.');
    }
    // END: Registro del Service Worker

    const token = localStorage.getItem('chat_token');
    if (token) {
        await validateSessionAndShowChat(token);
    } else {
        showLoginView();
    }
}





async function validateSessionAndShowChat(token) {
    try {
        const response = await fetch('/me', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Token inválido o sesión expirada');
        loggedInUser = await response.json();
        await showChatView();

        // Configura las notificaciones SOLO DESPUÉS de registrar el Service Worker
        setupPushNotifications(loggedInUser.uuid);
    } catch (error) {
        console.error("Error de sesión:", error);
        localStorage.removeItem('chat_token');
        showLoginView();
    }
}


function showLoginView() {
    chatContainer.style.display = 'none';
    loginView.style.display = 'block';
    document.getElementById('app-footer').style.display = 'block';
    usernameInput.focus();
}

async function showChatView() {
    loginView.style.display = 'none';
    chatContainer.style.display = 'flex';
    document.getElementById('app-footer').style.display = 'none';
    currentUserNameEl.textContent = `Hola, ${loggedInUser.name}`;
    await loadProjectChats();
    populateContacts();
}

async function login() {
  const name = usernameInput.value.trim();
  const password = passwordInput.value;
  if (!name || !password) {
    alert("Por favor, introduce nombre de usuario y contraseña.");
    return;
  }
  try {
    const response = await fetch('/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, password })
    });
    if (!response.ok) throw new Error('Credenciales incorrectas'); 
    const data = await response.json();
    localStorage.setItem('chat_token', data.token);
    loggedInUser = data.user;
    await showChatView();

    // Configure notifications after a successful login
    setupPushNotifications(loggedInUser.uuid);
  } catch (error) {
    console.error("Error de login:", error);
    alert("Login fallido. Revisa tu usuario y contraseña.");
  }
}

function logout() {
    localStorage.removeItem('chat_token');
    window.location.reload();
}

function toggleDropdown(dropdownId) {
    for (let i = 0; i < dropdownMenus.length; i++) {
        let openDropdown = dropdownMenus[i];
        if (openDropdown.id !== dropdownId && openDropdown.classList.contains('show')) {
            openDropdown.classList.remove('show');
        }
    }
    document.getElementById(dropdownId).classList.toggle("show");
}

function stringToColor(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  let color = '#';
  for (let i = 0; i < 3; i++) {
    const value = (hash >> (i * 8)) & 0xFF;
    color += ('00' + value.toString(16)).substr(-2);
  }
  return color;
}

function handleBackToContacts() {
    chatContainer.classList.remove('chat-active-mobile');
    if (messagePollingInterval) clearInterval(messagePollingInterval);
    activeChat = null;
    document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
}

function populateContacts() {
  contactsList.innerHTML = '';
  const otherUsers = USERS.filter(u => u.uuid !== loggedInUser.uuid);
  otherUsers.forEach(user => {
    const contactDiv = document.createElement('div');
    contactDiv.className = 'contact-item';

    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'contact-avatar';
    avatarDiv.style.backgroundColor = stringToColor(user.name);
    avatarDiv.textContent = user.name.charAt(0);

    const nameSpan = document.createElement('span');
    nameSpan.textContent = user.name;
    
    contactDiv.appendChild(avatarDiv);
    contactDiv.appendChild(nameSpan);

    contactDiv.dataset.userId = user.uuid;
    contactDiv.onclick = () => openChatWithUser(user);
    contactsList.appendChild(contactDiv);
  });
}

async function loadProjectChats() {
  try {
    const response = await fetch(`${API_BASE}/chats`, {
      headers: { 'X-Project-Id': PROJECT_ID, 'X-Api-Key': API_KEY }
    });
    if (!response.ok) throw new Error('Fallo al cargar los chats');
    projectChats = await response.json();
  } catch (error) {
    console.error("Error cargando los chats del proyecto:", error);
  }
}

async function openChatWithUser(contactUser) {
  if (messagePollingInterval) clearInterval(messagePollingInterval);

  document.querySelectorAll('.contact-item').forEach(el => el.classList.remove('active'));
  document.querySelector(`.contact-item[data-user-id='${contactUser.uuid}']`)?.classList.add('active');
  chatContainer.classList.add('chat-active-mobile');

  let chat = projectChats.find(c =>
    c.type === 'direct' && c.users.length === 2 &&
    c.users.includes(loggedInUser.uuid) && c.users.includes(contactUser.uuid)
  );

  if (!chat) {
    try {
      const response = await fetch(`${API_BASE}/chats/direct`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Project-Id': PROJECT_ID, 'X-Api-Key': API_KEY
        },
        body: JSON.stringify({ users: [loggedInUser.uuid, contactUser.uuid] })
      });
      if (!response.ok) throw new Error('Fallo al crear el chat remoto');
      chat = await response.json();
      projectChats.push(chat);
    } catch (error) {
      console.error("Error creando el chat remoto:", error);
      alert("No se pudo crear un nuevo chat remoto.");
      return;
    }
  }

  activeChat = chat;
  placeholderRightPanel.style.display = 'none';
  chatWindow.style.display = 'flex';
  chatPartnerName.textContent = `Chat con ${contactUser.name}`;
  messageInput.focus();

  await loadMessages();
  messagePollingInterval = setInterval(loadMessages, 3000);
}

async function loadMessages() {
  if (!activeChat) return;
  try {
    const response = await fetch(`${API_BASE}/chats/${activeChat.id}/messages`, {
      headers: { 'X-Project-Id': PROJECT_ID, 'X-Api-Key': API_KEY }
    });
    if (!response.ok) throw new Error('Fallo al cargar los mensajes');
    const messages = await response.json();
    renderMessages(messages);
  } catch (error) {
    console.error(`Error cargando mensajes para el chat ${activeChat.id}:`, error);
  }
}

function renderMessages(messages) {
  const shouldScroll = messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 30;
  
  messagesContainer.innerHTML = '';
  messages.forEach(msg => {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + (msg.sender_id === loggedInUser.uuid ? 'sent' : 'received');

    const messageText = document.createElement('div');
    messageText.textContent = msg.text;

    const messageTimestamp = document.createElement('span');
    messageTimestamp.textContent = new Date(msg.timestamp).toLocaleString();
    messageTimestamp.style.cssText = `font-size: 0.7em; display: block; color: ${msg.sender_id === loggedInUser.uuid ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.5)'};`;

    messageDiv.appendChild(messageText);
    messageDiv.appendChild(messageTimestamp);
    messagesContainer.appendChild(messageDiv);
  });

  if (shouldScroll) {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }
}

async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text || !activeChat) return;

  try {
    await fetch(`${API_BASE}/chats/${activeChat.id}/messages`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Project-Id': PROJECT_ID, 'X-Api-Key': API_KEY
      },
      body: JSON.stringify({ sender_id: loggedInUser.uuid, text })
    });
    messageInput.value = '';
    messageInput.focus();
    await loadMessages();
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  } catch (error) {
    console.error("Error enviando el mensaje:", error);
    alert("No se pudo enviar el mensaje.");
  }
}




// // START: New Push Notification Logic
// async function setupPushNotifications(user_uuid) {
//     if (!messaging) return;

//     try {
//         const permission = await Notification.requestPermission();
//         if (permission === 'granted') {
//             const currentToken = await messaging.getToken();
//             if (currentToken) {
//                 console.log('FCM token:', currentToken);
//                 await sendTokenToServer(user_uuid, currentToken);
//             } else {
//                 console.log('No se pudo obtener el token. ¿Permiso revocado?');
//             }
//         } else {
//             console.log('Permiso de notificación denegado.');
//         }
//     } catch (error) {
//         console.error('Error durante la configuración de notificaciones:', error);
//     }
// }




async function setupPushNotifications(user_uuid) {
    if (!messaging) {
        console.error('El objeto de mensajería de Firebase no está disponible.');
        return;
    }

    try {
        // 1. Solicitar el permiso al usuario de forma clara.
        const permission = await Notification.requestPermission();

        if (permission !== 'granted') {
            console.warn('Permiso de notificación denegado o no concedido.');
            return;
        }

        // 2. Obtener el token FCM solo si el permiso fue concedido.
        const currentToken = await messaging.getToken({
            vapidKey: 'BCxDJFfgEvdjyLUGKaRjo3jETp_BAFzRbqgmB1ULwwzEntFi_aQCkwohI-fS4SvtY9qOqMfeIm377GrTDm8n1tI' // ¡Importante! Reemplaza con tu clave VAPID
        });

        if (!currentToken) {
            console.warn('No se pudo obtener el token FCM.');
            return;
        }

        // 3. Registrar el token en el servidor.
        console.log('Token FCM obtenido:', currentToken);
        await sendTokenToServer(user_uuid, currentToken);
        console.log('Token registrado en el servidor exitosamente.');

    } catch (error) {
        // 4. Manejo de errores centralizado para una mejor depuración.
        console.error('Error en la configuración de notificaciones push:', error);

        if (error.code === 'messaging/permission-denied') {
            console.error('El usuario ha bloqueado permanentemente las notificaciones.');
        } else if (error.code === 'messaging/unsupported-browser') {
            console.error('El navegador no soporta la API de mensajería de Firebase.');
        } else {
            // Error desconocido, se propaga para una mejor depuración.
            throw error; 
        }
    }
}



async function sendTokenToServer(user_id, fcm_token) {
    try {
        const response = await fetch(`${API_BASE}/save-fcm-token`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id, fcm_token })
        });

        if (!response.ok) {
            console.error('Error al guardar el token en el servidor.');
        }
    } catch (error) {
        console.error('Error de red al enviar el token:', error);
    }
}
// END: New Push Notification Logic

window.onload = initializeApp;
</script>




</body>
</html>